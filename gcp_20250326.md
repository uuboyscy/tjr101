### GCP 20250426

---

## ä¸€ã€ä¸Šå‚³æª”æ¡ˆèˆ‡åˆæ­¥è¨­å®šï¼ˆBigQuery External Tableï¼‰

- ç¢ºèªæª”æ¡ˆå·²æˆåŠŸä¸Šå‚³è‡³GCSã€‚
- ä»‹ç´¹Source Data Partitionï¼ˆè³‡æ–™åˆ†å€ï¼‰æ¦‚å¿µï¼š
  - åŠ å¿«æŸ¥è©¢é€Ÿåº¦ã€é™ä½è²»ç”¨ã€‚
  - ä¾‹å¦‚ä»¥æ—¥æœŸï¼ˆdt=yyyy-mm-ddï¼‰ä¾†åŠƒåˆ†ã€‚
- External Table VS Native Tableï¼š
  - Native Tableï¼šèˆ‡åŸå§‹CSVè„«é‰¤ï¼Œéœæ…‹è³‡æ–™ã€‚
  - External Tableï¼šé€£å‹•CSVå…§å®¹ï¼Œå³æ™‚åæ˜ æ›´æ–°ã€‚
- Schemaè¨­å®šå»ºè­°ï¼š
  - **ä¸è¦ä½¿ç”¨Auto-detect**ï¼Œé¿å…å‹åˆ¥èª¤åˆ¤ã€‚
  - **å»ºè­°è‡ªè¡Œæ‰‹å‹•è¨­å®šæ¬„ä½èˆ‡å‹åˆ¥**ã€‚

ğŸ› ï¸ **æŒ‡ä»¤ç¯„ä¾‹**
```bash
# ä½¿ç”¨gsutilä¸Šå‚³è³‡æ–™å¤¾
gsutil -m rsync -r ./local_folder/ gs://your-bucket-name/path/

# ä¸Šå‚³å–®ä¸€æª”æ¡ˆ
gsutil cp ./file.csv gs://your-bucket-name/path/
```

---

## äºŒã€å»ºç«‹Partition External Tableæµç¨‹

- è³‡æ–™å¤¾å‘½åéµå¾ª Hive Styleï¼š`dt=YYYY-MM-DD`ã€‚
- åŒæ­¥æœ¬åœ°è³‡æ–™åˆ°GCSå¾Œï¼Œå»ºç«‹External Tableã€‚
- ç”¨SQLèªæ³•å‰µå»ºExternal Tableä¸¦è¨­åˆ†å€ã€‚

ğŸ› ï¸ **SQLæŒ‡ä»¤ç¯„ä¾‹**
```sql
CREATE EXTERNAL TABLE `your_dataset.external_table`
(
    transaction_id INT64,
    product_id INT64,
    quantity INT64,
    price FLOAT64
)
PARTITION BY DATE(dt)
OPTIONS (
  format = 'CSV',
  uris = ['gs://your-bucket-name/path/*']
);
```
âœ… **éœ€è¦ä¿®æ”¹**ï¼š`dataset` åç¨±ã€`table` åç¨±ã€`GCS URI`ã€‚

- æŸ¥è©¢æ™‚è‡ªå‹•å‡ºç¾ `dt` æ¬„ä½ï¼Œå‹åˆ¥è‡ªå‹•è½‰ç‚ºDateã€‚
- æ–°å¢è³‡æ–™å¤¾å¾Œï¼ˆæ–°æ—¥æœŸï¼‰ï¼Œåªéœ€é‡æ–°`rsync`ï¼Œä¸å¿…é‡å»ºè¡¨ã€‚

---

## ä¸‰ã€External Tableè³‡æ–™å³æ™‚æ›´æ–°ç‰¹æ€§

- **External Table ç„¡æ³•ç›´æ¥Insertæˆ–Updateè³‡æ–™ã€‚**
- ä¿®æ”¹åŸå§‹æª”æ¡ˆå¾Œï¼ŒæŸ¥è©¢çµæœå³æ™‚æ›´æ–°ã€‚

ğŸ› ï¸ **è£œå……çŸ¥è­˜**
- **Native Table**ï¼šéœ€é‡æ–°Loadæˆ–Insertã€‚
- **External Table**ï¼šç›´æ¥åæ˜ GCSä¸Šçš„æª”æ¡ˆå…§å®¹ã€‚

---

## å››ã€ä½¿ç”¨SQLå‰µå»ºExternal Tableï¼ˆGoogle Sheetsï¼‰

- ä¹Ÿå¯ä»¥å°‡Google Sheetsç•¶ä½œExternal Tableä½¿ç”¨ã€‚
- æ”¯æ´ç”¨SQLç›´æ¥å‰µå»ºã€‚
- é€™æ˜¯è¿‘å¹¾å¹´GCPæ–°å¢åŠŸèƒ½ï¼Œä»¥å‰è¦APIæ“ä½œã€‚

ğŸ› ï¸ **SQLç°¡æ˜“ç¯„ä¾‹**
```sql
CREATE EXTERNAL TABLE `your_dataset.sheet_table`
WITH CONNECTION `your_project.location.connection_id`
OPTIONS (
  format = 'GOOGLE_SHEETS',
  uris = ['https://docs.google.com/spreadsheets/d/your_sheet_id']
);
```

âœ… è¨˜å¾—å…ˆè¨­å®šå¥½Google Sheetsé€£çµçš„æ¬Šé™ã€‚

---

## äº”ã€Pythoné€£æ¥BigQueryæµç¨‹

- å®‰è£BigQuery Pythonå¥—ä»¶

ğŸ› ï¸ **å®‰è£æŒ‡ä»¤**
```bash
# ç”¨Poetryå®‰è£
poetry add google-cloud-bigquery

# æˆ–ç”¨Pipå®‰è£
pip install google-cloud-bigquery
```

- å»ºç«‹å°ˆæ¡ˆè™›æ“¬ç’°å¢ƒ

ğŸ› ï¸ **å»ºç«‹å°ˆæ¡ˆæŒ‡ä»¤**
```bash
poetry init
```
ä¸€è·¯æŒ‰ Enter å¿«é€Ÿåˆå§‹åŒ–å°ˆæ¡ˆã€‚

- è¨­å®šVSCodeè™›æ“¬ç’°å¢ƒInterpreterï¼š
  - æ‰¾åˆ° `.venv/bin/python`ï¼ˆæˆ–é¡ä¼¼ï¼‰è·¯å¾‘ã€‚
  - åœ¨VSCodeåº•ä¸‹é»Pythonç’°å¢ƒé¸æ“‡å™¨ï¼Œè¼¸å…¥è©²è·¯å¾‘ã€‚

- Pythonç¨‹å¼ç¢¼æ“ä½œBigQuery

ğŸ› ï¸ **ç¨‹å¼ç¯„ä¾‹**
```python
from google.cloud import bigquery

client = bigquery.Client()
query = "SELECT * FROM `bigquery-public-data.samples.shakespeare` LIMIT 10"
query_job = client.query(query)

for row in query_job:
    print(row)
```

âœ… ä¹Ÿå¯ä»¥ä½¿ç”¨ `.to_dataframe()` è½‰ç‚ºPandas DataFrameï¼š
```python
import pandas as pd

query_job = client.query(query)
df = query_job.to_dataframe()
print(df)
```

---

## å…­ã€Service Accountå»ºç«‹èˆ‡è¨­å®š

- åœ¨GCPå»ºç«‹Service Accountã€‚
- çµ¦äºˆBigQuery Adminæ¬Šé™ï¼ˆé–‹ç™¼éšæ®µæ–¹ä¾¿å…ˆçµ¦å¤§æ¬Šé™ï¼‰ã€‚
- ä¸‹è¼‰JSONæ ¼å¼é‡‘é‘°ã€‚

ğŸ› ï¸ **ç’°å¢ƒè®Šæ•¸è¨­å®šæ–¹å¼**
```bash
# è¨­å®šGoogleæ‡‰ç”¨ç¨‹å¼é‡‘é‘°
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/your-service-account-key.json"
```

âœ… ä¹Ÿå¯ä»¥åœ¨ç¨‹å¼å…§è¨­å®šé‡‘é‘°ï¼š
```python
from google.oauth2 import service_account

credentials = service_account.Credentials.from_service_account_file('/path/to/your-service-account-key.json')
client = bigquery.Client(credentials=credentials)
```

---

## ä¸ƒã€æ³¨æ„äº‹é …èˆ‡å¸¸è¦‹éŒ¯èª¤

- ä¸Šå‚³è³‡æ–™å¤¾æ™‚ï¼Œä¸€å®šè¦ä¿æŒHiveæ ¼å¼ï¼ˆdt=YYYY-MM-DDï¼‰ã€‚
- å¤–éƒ¨è¡¨ï¼ˆExternal Tableï¼‰åªè®€å–è³‡æ–™ï¼Œä¸å¯ä»¥ç”¨SQLæ”¹å¯«è³‡æ–™ã€‚
- Service Accounté‡‘é‘° **çµ•å°ä¸èƒ½ä¸Šå‚³åˆ°GitHub**ã€‚
- è³‡æ–™åŒæ­¥æ™‚è¨˜å¾—ç”¨`gsutil rsync`ï¼Œç¢ºä¿è³‡æ–™å®Œæ•´ã€‚

ğŸ› ï¸ **gsutilå¸¸ç”¨æŒ‡ä»¤è£œå……**
```bash
# ä¸Šå‚³å–®å€‹æª”æ¡ˆ
gsutil cp ./local_file.csv gs://your-bucket-name/folder/

# ä¸Šå‚³æ•´å€‹è³‡æ–™å¤¾ä¸¦åŒæ­¥
gsutil -m rsync -r ./local_folder gs://your-bucket-name/folder

# æª¢æŸ¥GCSå…§å®¹
gsutil ls gs://your-bucket-name/folder/
```

---

## ä¸‹æ¬¡èª²ç¨‹é å‘Š

- æ“ä½œGoogle Sheets External Tableæ¬Šé™ç´°ç¯€ã€‚
- æ›´é€²éšçš„BigQueryæŸ¥è©¢å„ªåŒ–æŠ€å·§ã€‚
- Pythonè‡ªå‹•åŒ–æŸ¥è©¢èˆ‡è³‡æ–™è™•ç†æµç¨‹å»ºç«‹ã€‚
